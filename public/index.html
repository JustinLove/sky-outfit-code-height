<!DOCTYPE HTML>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Sky Outfit Code Height</title>
  <link href="style.css" rel="stylesheet" />
  <script type="text/javascript" src="sky-outfit-code-height.js"></script>
  <script type="text/javascript" src="lz4-decompress-block.js"></script>
</head>

<body>
</body>

<script type="module">
var search = window.location.search;
var app = Elm.SkyOutfitCodeHeight.init({flags: search})

// ------------------- Lz4 --------------------
if (app.ports.lz4DecompressBlock) {
  app.ports.lz4DecompressBlock.subscribe(function(base64text) {
    try {
      var buffer = Uint8Array.fromBase64(base64text)
      var output = new Array(2000)
      var decodedCount = lz4.decompressBlock(buffer, output, 0, buffer.length, 0)
      var trunc = output.slice(0,decodedCount)
      var decodedText = new TextDecoder().decode(Uint8Array.from(trunc))
      app.ports.lz4BlockDecompressed.send(decodedText)
    } catch (e) {
      app.ports.lz4Error.send(e)
    }
  })
}

// ------------------- FormatJson --------------------
if (app.ports.formatJson) {
  app.ports.formatJson.subscribe(function(uglyString) {
    try {
      var prettyString = JSON.stringify(JSON.parse(uglyString), null, 2)
      app.ports.formattedJson.send(prettyString)
    } catch (e) {
      app.ports.formatJsonError.send(e)
    }
  })
}

// ------------------- QrScanner --------------------
import QrScanner from './qr-scanner.min.js'
if (app.ports.qrCommand) {
  var cameraScanner

  function createCameraScanner() {
    try {
      var videoElement = document.getElementById('qrwebcam')
      if (videoElement) {
        return new QrScanner(videoElement,
          function(result) {
            app.ports.qrEvent.send({
              kind: 'cameraScanned',
              result: result,
            })
          },
          {
            returnDetailedScanResult: true,
            /*onDecodeError: function(error) {
              // console.log(error)
              app.ports.qrEvent.send({
                kind: 'cameraError',
                error: error,
              })
            },*/
          })
      }
    } catch (e) {
      app.ports.qrEvent.send({
        kind: 'cameraError',
        error: e,
      })
    }
  }

  function scanImage(file) {
    try {
      QrScanner.scanImage(file, {returnDetailedScanResult: true})
        .then(function(result) {
          app.ports.qrEvent.send({
            kind: 'fileScanned',
            result: result,
          })
        })
        .catch(function(error) {
          app.ports.qrEvent.send({
            kind: 'fileError',
            error: error,
          })
        })
    } catch (e) {
      app.ports.qrEvent.send({
        kind: 'fileError',
        error: e,
      })
    }
  }

  function command(message) {
    try {
      switch (message.kind) {
        case "scanImage":
          scanImage(message.file)
          break
        case "startCamera":
          if (!cameraScanner) {
            cameraScanner = createCameraScanner()
          }
          if (cameraScanner) {
            cameraScanner.start().catch(function(error) {
              app.ports.qrEvent.send({
                kind: 'cameraError',
                error: error,
              })
            })
          }
          break
        case "stopCamera":
          if (cameraScanner) {
            cameraScanner.stop()
          }
          break
        default:
          console.log('unknown command', message)
          break
      }
    } catch (e) {
      app.ports.qrEvent.send({
        kind: 'error',
        error: e,
      })
    }
  }

  app.ports.qrCommand.subscribe(command)

  QrScanner.hasCamera().then(function(hasCamera) {
    app.ports.qrEvent.send({
      kind: 'hasCamera',
      hasCamera: hasCamera,
    })
  })
}

</script>
<!--script defer src="svgxuse.js"></script-->

</html>

